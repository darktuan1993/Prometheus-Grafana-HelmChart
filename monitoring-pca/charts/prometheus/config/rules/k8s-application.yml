groups:
  - name: Rules
    rules:
      # Node Down
      - alert: Cảnh Báo Server
        expr:  up{instance=~".+",job="k8s-bravoapp-node"} == 0
        for: 1m
        labels:
          severity: Khẩn cấp
          app_type: Cluster Application
          category: server
          instance: "{{ $labels.instance }}"
        annotations:
          summary: "Service giám sát hoặc server bị tắt trên máy chủ {{ $labels.instance }}"
          description: | 
                Vui lòng kiểm tra lại !


      # Ram Rules
      - alert: Cảnh báo RAM
        expr: (node_memory_MemTotal_bytes{job="k8s-bravoapp-node", instance=~".+"} - node_memory_MemFree_bytes{job="k8s-bravoapp-node", instance=~".+"} - node_memory_Buffers_bytes{job="k8s-bravoapp-node", instance=~".+"} - node_memory_Cached_bytes{job="k8s-bravoapp-node", instance=~".+"} ) / (node_memory_MemTotal_bytes{job="k8s-bravoapp-node", instance=~".+"}) * 100 > 0
        for: 1m
        labels:
          severity: Khẩn cấp
          app_type: Cluster Application
          category: memory
          instance: "{{ $labels.instance }}"
        annotations:
          summary: "RAM Server > 95%"
          description: |
            RAM đã sử dụng chiếm {{ printf "%.2f" $value }}% / 100%

            Thông Tin Cụ Thể:

                 * TOTAL RAM: {{ query (printf "node_memory_MemTotal_bytes{job='K8s-bravoapp-node', instance=~'%s'}" $labels.instance) | first | value  | humanize1024}}

                 * Ram sử dụng: {{ query (printf "node_memory_MemTotal_bytes{job='K8s-bravoapp-node', instance=~'%s'} - node_memory_MemFree_bytes{job='K8s-bravoapp-node', instance=~'%s'} - node_memory_Cached_bytes{job='K8s-bravoapp-node', instance=~'%s'} - node_memory_Buffers_bytes{job='K8s-bravoapp-node', instance=~'%s'}" $labels.instance $labels.instance $labels.instance $labels.instance) | first | value | humanize1024 }}
                                   
                 * Ram Cache/buffe: {{ query (printf "node_memory_Cached_bytes{job='K8s-bravoapp-node', instance=~'%s'} + node_memory_Buffers_bytes{job='K8s-bravoapp-node', instance=~'%s'}" $labels.instance $labels.instance) | first | value  | humanize1024}}

                 * Ram còn lại:  {{ query (printf "node_memory_MemFree_bytes{job='K8s-bravoapp-node', instance=~'%s'}" $labels.instance) | first | value | humanize1024 }}
